---
# Development role - tasks
# Sets up development tools and programming language environments

- name: Install development packages
  ansible.builtin.apt:
    name: "{{ development_packages }}"
    state: present
  tags: packages

- name: Install Python packages
  ansible.builtin.apt:
    name: "{{ python_packages }}"
    state: present
  when: install_python | default(true)
  tags: python

- name: Install Python pip packages (user space)
  ansible.builtin.pip:
    name: "{{ pip_packages }}"
    state: present
    executable: pip3
    extra_args: "--user --break-system-packages"
  become: true
  become_user: "{{ target_user }}"
  when:
    - install_python | default(true)
    - pip_packages is defined
    - pip_packages | length > 0
  tags: python

- name: Extract Node.js major version
  ansible.builtin.set_fact:
    nodejs_major_version: "{{ nodejs_version.split('.')[0] }}"
  when: install_nodejs | default(false)
  tags: nodejs

- name: Download NodeSource setup script
  ansible.builtin.get_url:
    url: "https://deb.nodesource.com/setup_{{ nodejs_major_version }}.x"
    dest: /tmp/nodesource_setup.sh
    mode: '0755'
  when: install_nodejs | default(false)
  tags: nodejs

- name: Run NodeSource setup script
  command: /tmp/nodesource_setup.sh
  args:
    creates: /etc/apt/sources.list.d/nodesource.list
  when: install_nodejs | default(false)
  tags: nodejs

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true
  when: install_nodejs | default(false)
  tags: nodejs

- name: Install npm global packages
  community.general.npm:
    name: "{{ item }}"
    global: true
    state: present
  loop: "{{ npm_global_packages }}"
  when:
    - install_nodejs | default(false)
    - npm_global_packages is defined
    - npm_global_packages | length > 0
  tags: nodejs

- name: Check if Go is installed
  ansible.builtin.stat:
    path: /usr/local/go/bin/go
  register: go_installed
  when: install_golang | default(false)
  tags: golang

- name: Get installed Go version
  ansible.builtin.command: /usr/local/go/bin/go version
  register: current_go_version
  changed_when: false
  failed_when: false
  when:
    - install_golang | default(false)
    - go_installed.stat.exists | default(false)
  tags: golang

- name: Set Go version needs update fact
  ansible.builtin.set_fact:
    go_needs_update: "{{ not go_installed.stat.exists | default(true) or (current_go_version.stdout is defined and ('go' + golang_version) not in current_go_version.stdout) }}"
  when: install_golang | default(false)
  tags: golang

- name: Display Go version status
  ansible.builtin.debug:
    msg: "Go {{ golang_version }} {{ 'needs installation/update' if go_needs_update else 'is already installed' }}"
  when: install_golang | default(false)
  tags: golang

- name: Go installation block
  when:
    - install_golang | default(false)
    - go_needs_update | default(true)
  tags: golang
  block:
    - name: Download Go
      ansible.builtin.get_url:
        url: "https://go.dev/dl/go{{ golang_version }}.linux-amd64.tar.gz"
        dest: "/tmp/go{{ golang_version }}.linux-amd64.tar.gz"
        mode: '0644'
      register: go_download
      retries: 3
      delay: 5
      until: go_download is succeeded

    - name: Remove old Go installation
      ansible.builtin.file:
        path: /usr/local/go
        state: absent

    - name: Extract Go archive
      ansible.builtin.unarchive:
        src: "/tmp/go{{ golang_version }}.linux-amd64.tar.gz"
        dest: /usr/local
        remote_src: true

    - name: Clean up Go archive
      ansible.builtin.file:
        path: "/tmp/go{{ golang_version }}.linux-amd64.tar.gz"
        state: absent

  rescue:
    - name: Go installation failed - display error
      ansible.builtin.debug:
        msg: "Go installation failed. Please check network connectivity and try again."

    - name: Clean up partial Go installation
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/go{{ golang_version }}.linux-amd64.tar.gz"
      failed_when: false

- name: Add Go to PATH
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED GO PATH"
    block: |
      # Go programming language
      export PATH=$PATH:/usr/local/go/bin
      export GOPATH=$HOME/go
      export PATH=$PATH:$GOPATH/bin
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_golang | default(false)
  tags: golang

- name: Rust installation block
  when: install_rust | default(false)
  tags: rust
  block:
    - name: Download rustup installer
      ansible.builtin.get_url:
        url: https://sh.rustup.rs
        dest: /tmp/rustup-init.sh
        mode: '0755'
      register: rustup_download
      retries: 3
      delay: 5
      until: rustup_download is succeeded

    - name: Install Rust via rustup
      ansible.builtin.shell: |
        /tmp/rustup-init.sh -y --default-toolchain stable
      args:
        creates: "/home/{{ target_user }}/.cargo/bin/rustc"
      become: true
      become_user: "{{ target_user }}"

    - name: Clean up rustup installer
      ansible.builtin.file:
        path: /tmp/rustup-init.sh
        state: absent

- name: Add Rust to PATH
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED RUST PATH"
    block: |
      # Rust programming language
      . "$HOME/.cargo/env"
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_rust | default(false)
  tags: rust

- name: Install Ruby and development headers
  ansible.builtin.apt:
    name:
      - ruby-full
      - ruby-dev
    state: present
  when: install_ruby | default(false)
  tags: ruby

- name: Configure gem installation directory for user
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED RUBY GEMS PATH"
    block: |
      # Ruby gems
      export GEM_HOME="$HOME/.gem"
      export PATH="$HOME/.gem/bin:$PATH"
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_ruby | default(false)
  tags: ruby

# ============================================================================
# Doppler CLI Installation
# ============================================================================

- name: Check if Doppler is installed
  command: doppler --version
  register: doppler_installed
  ignore_errors: true
  changed_when: false
  when: install_doppler | default(false)
  tags: doppler

- name: Install Doppler CLI
  when:
    - install_doppler | default(false)
    - doppler_installed is failed
  tags: doppler
  block:
    - name: Install prerequisites for Doppler
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Download Doppler GPG key
      ansible.builtin.get_url:
        url: https://packages.doppler.com/public/cli/gpg.DE2A7741A397C129.key
        dest: /tmp/doppler.gpg.asc
        mode: '0644'
      register: doppler_gpg_download
      retries: 3
      delay: 5
      until: doppler_gpg_download is succeeded

    - name: Dearmor and install Doppler GPG key
      ansible.builtin.shell: |
        gpg --dearmor < /tmp/doppler.gpg.asc > /usr/share/keyrings/doppler-archive-keyring.gpg
        chmod 644 /usr/share/keyrings/doppler-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/doppler-archive-keyring.gpg

    - name: Clean up temporary Doppler GPG key
      ansible.builtin.file:
        path: /tmp/doppler.gpg.asc
        state: absent

    - name: Add Doppler repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/doppler-archive-keyring.gpg] https://packages.doppler.com/public/cli/deb/debian any-version main"
        filename: doppler-cli
        state: present

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: Install Doppler CLI
      ansible.builtin.apt:
        name: doppler
        state: present

- name: Verify Doppler installation
  command: doppler --version
  register: doppler_version_output
  changed_when: false
  when: install_doppler | default(false)
  tags: doppler

- name: Display Doppler version
  ansible.builtin.debug:
    msg: "Doppler CLI installed: {{ doppler_version_output.stdout }}"
  when:
    - install_doppler | default(false)
    - doppler_version_output is defined
  tags: doppler

# ============================================================================
# Nix Package Manager Installation
# ============================================================================

- name: Check if Nix is installed
  ansible.builtin.stat:
    path: /nix/var/nix/profiles/default/bin/nix
  register: nix_installed
  when: install_nix | default(false)
  tags: nix

- name: Install Nix package manager
  when:
    - install_nix | default(false)
    - not nix_installed.stat.exists
  tags: nix
  block:
    - name: Download Nix installer
      ansible.builtin.get_url:
        url: https://nixos.org/nix/install
        dest: /tmp/nix-install.sh
        mode: '0755'
      register: nix_download
      retries: 3
      delay: 5
      until: nix_download is succeeded

    - name: Run Nix installer (multi-user mode with no profile modification)
      ansible.builtin.shell: |
        /tmp/nix-install.sh --daemon --yes --no-modify-profile
      args:
        creates: /nix/var/nix/profiles/default/bin/nix

    - name: Remove Nix installer script
      ansible.builtin.file:
        path: /tmp/nix-install.sh
        state: absent

  rescue:
    - name: Nix installation failed - display error
      ansible.builtin.debug:
        msg: "Nix installation failed. This may be due to missing systemd or other dependencies."

    - name: Clean up partial Nix installation
      ansible.builtin.file:
        path: /tmp/nix-install.sh
        state: absent
      failed_when: false

- name: Configure Nix for user
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED NIX PATH"
    block: |
      # Nix package manager
      if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      fi
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_nix | default(false)
  tags: nix

- name: Enable nix-daemon service
  ansible.builtin.systemd:
    name: nix-daemon
    enabled: true
    state: started
  when:
    - install_nix | default(false)
    - not nix_installed.stat.exists
  ignore_errors: true
  tags: nix

- name: Create Nix configuration directory
  ansible.builtin.file:
    path: /etc/nix
    state: directory
    mode: '0755'
  when: install_nix | default(false)
  tags: nix

- name: Configure Nix experimental features
  ansible.builtin.lineinfile:
    path: /etc/nix/nix.conf
    line: "experimental-features = nix-command flakes"
    create: true
    mode: '0644'
  when: install_nix | default(false)
  tags: nix

- name: Restart nix-daemon to apply configuration
  ansible.builtin.systemd:
    name: nix-daemon
    state: restarted
  when:
    - install_nix | default(false)
  ignore_errors: true
  tags: nix

- name: Verify Nix installation
  ansible.builtin.shell: |
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    nix --version
  register: nix_version_output
  changed_when: false
  when:
    - install_nix | default(false)
    - nix_installed.stat.exists or (nix_installed is defined and not nix_installed.stat.exists)
  ignore_errors: true
  tags: nix

- name: Display Nix version
  ansible.builtin.debug:
    msg: "Nix package manager installed: {{ nix_version_output.stdout }}"
  when:
    - install_nix | default(false)
    - nix_version_output is defined
    - nix_version_output.stdout is defined
  tags: nix

# ============================================================================
# GitHub CLI Installation
# ============================================================================

- name: Check if GitHub CLI is installed
  ansible.builtin.command: gh --version
  register: gh_installed
  ignore_errors: true
  changed_when: false
  when: install_gh_cli | default(false)
  tags: gh

- name: Install GitHub CLI
  when:
    - install_gh_cli | default(false)
    - gh_installed is failed
  tags: gh
  block:
    - name: Install prerequisites for GitHub CLI
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Download GitHub CLI GPG key
      ansible.builtin.get_url:
        url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
        dest: /tmp/githubcli-archive-keyring.gpg
        mode: '0644'
      register: gh_gpg_download
      retries: 3
      delay: 5
      until: gh_gpg_download is succeeded

    - name: Dearmor and install GitHub CLI GPG key
      ansible.builtin.shell: |
        gpg --dearmor < /tmp/githubcli-archive-keyring.gpg > /etc/apt/keyrings/githubcli-archive-keyring.gpg
        chmod 644 /etc/apt/keyrings/githubcli-archive-keyring.gpg
      args:
        creates: /etc/apt/keyrings/githubcli-archive-keyring.gpg

    - name: Clean up temporary GitHub CLI GPG key
      ansible.builtin.file:
        path: /tmp/githubcli-archive-keyring.gpg
        state: absent

    - name: Add GitHub CLI repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
        filename: github-cli
        state: present

    - name: Update apt cache for GitHub CLI
      ansible.builtin.apt:
        update_cache: true

    - name: Install GitHub CLI from apt repository
      ansible.builtin.apt:
        name: gh
        state: "{{ 'latest' if gh_cli_version | default('latest') == 'latest' else 'present' }}"
      environment:
        DEBIAN_FRONTEND: noninteractive

  rescue:
    - name: GitHub CLI installation failed - display error
      ansible.builtin.debug:
        msg: "GitHub CLI installation failed. Please check network connectivity and try again."

    - name: Clean up partial GitHub CLI installation
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/gh.deb
        - /tmp/githubcli-archive-keyring.gpg
      failed_when: false

- name: Verify GitHub CLI installation
  ansible.builtin.command: gh --version
  register: gh_version_output
  changed_when: false
  when: install_gh_cli | default(false)
  tags: gh

- name: Display GitHub CLI version
  ansible.builtin.debug:
    msg: "GitHub CLI installed: {{ gh_version_output.stdout_lines[0] }}"
  when:
    - install_gh_cli | default(false)
    - gh_version_output is defined
    - gh_version_output.stdout_lines is defined
  tags: gh
