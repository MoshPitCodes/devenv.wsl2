---
# Kubernetes tools role - tasks
# Installs Terraform, kubectl, and talosctl

- name: Check disk space before Kubernetes tools installation
  ansible.builtin.include_tasks:
    file: "{{ playbook_dir }}/../roles/common/tasks/check_disk_space.yml"
  vars:
    required_space_mb: 300
    check_path: "/tmp"
  tags: always

- name: Determine system architecture
  ansible.builtin.set_fact:
    system_arch: "{{ architecture_map[ansible_architecture] | default('amd64') }}"
  tags: always

# ============================================================================
# Terraform Installation
# ============================================================================

- name: Check if Terraform is installed
  command: terraform version
  register: terraform_installed
  ignore_errors: true
  changed_when: false
  when: install_terraform | default(true)
  tags: terraform

- name: Get installed Terraform version
  ansible.builtin.set_fact:
    installed_terraform_version: "{{ terraform_installed.stdout | regex_search('Terraform v([0-9.]+)', '\\1') | first }}"
  when:
    - install_terraform | default(true)
    - terraform_installed is succeeded
  ignore_errors: true
  tags: terraform

- name: Install/Update Terraform
  when:
    - install_terraform | default(true)
    - terraform_installed is failed or (installed_terraform_version is defined and installed_terraform_version != terraform_version)
  tags: terraform
  block:
    - name: Download Terraform checksums
      ansible.builtin.get_url:
        url: "https://releases.hashicorp.com/terraform/{{ terraform_version }}/terraform_{{ terraform_version }}_SHA256SUMS"
        dest: "/tmp/terraform_{{ terraform_version }}_SHA256SUMS"
        mode: '0644'
      register: terraform_checksum_download
      retries: 3
      delay: 5
      until: terraform_checksum_download is succeeded

    - name: Download Terraform checksums signature
      ansible.builtin.get_url:
        url: "https://releases.hashicorp.com/terraform/{{ terraform_version }}/terraform_{{ terraform_version }}_SHA256SUMS.sig"
        dest: "/tmp/terraform_{{ terraform_version }}_SHA256SUMS.sig"
        mode: '0644'
      register: terraform_sig_download
      retries: 3
      delay: 5
      until: terraform_sig_download is succeeded

    - name: Check if HashiCorp GPG key is already imported
      ansible.builtin.shell: |
        gpg --list-keys 34365D9472D7468F 2>/dev/null
      register: hashicorp_key_check
      changed_when: false
      failed_when: false

    - name: Download HashiCorp GPG key
      ansible.builtin.get_url:
        url: https://keybase.io/hashicorp/pgp_keys.asc
        dest: /tmp/hashicorp_gpg.asc
        mode: '0644'
      when: hashicorp_key_check.rc != 0
      register: hashicorp_gpg_download
      retries: 3
      delay: 5
      until: hashicorp_gpg_download is succeeded

    - name: Import HashiCorp GPG key
      ansible.builtin.shell: |
        gpg --import /tmp/hashicorp_gpg.asc
      when: hashicorp_key_check.rc != 0
      changed_when: false

    - name: Clean up HashiCorp GPG key file
      ansible.builtin.file:
        path: /tmp/hashicorp_gpg.asc
        state: absent
      when: hashicorp_key_check.rc != 0

    - name: Verify Terraform checksums signature
      ansible.builtin.shell: |
        gpg --verify /tmp/terraform_{{ terraform_version }}_SHA256SUMS.sig \
                     /tmp/terraform_{{ terraform_version }}_SHA256SUMS
      changed_when: false

    - name: Download Terraform binary
      ansible.builtin.get_url:
        url: "https://releases.hashicorp.com/terraform/{{ terraform_version }}/terraform_{{ terraform_version }}_linux_{{ system_arch }}.zip"
        dest: "/tmp/terraform_{{ terraform_version }}_linux_{{ system_arch }}.zip"
        mode: '0644'
      register: terraform_download
      retries: 3
      delay: 5
      until: terraform_download is succeeded

    - name: Verify Terraform binary checksum
      ansible.builtin.shell: |
        cd /tmp
        grep "terraform_{{ terraform_version }}_linux_{{ system_arch }}.zip" \
             terraform_{{ terraform_version }}_SHA256SUMS | sha256sum -c -
      changed_when: false

    - name: Unzip Terraform
      ansible.builtin.unarchive:
        src: "/tmp/terraform_{{ terraform_version }}_linux_{{ system_arch }}.zip"
        dest: "{{ bin_directory }}"
        remote_src: true
        mode: '0755'

    - name: Clean up Terraform files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/terraform_{{ terraform_version }}_linux_{{ system_arch }}.zip"
        - "/tmp/terraform_{{ terraform_version }}_SHA256SUMS"
        - "/tmp/terraform_{{ terraform_version }}_SHA256SUMS.sig"

- name: Verify Terraform installation
  command: terraform version
  register: terraform_version_output
  changed_when: false
  when: install_terraform | default(true)
  tags: terraform

- name: Display Terraform version
  ansible.builtin.debug:
    msg: "Terraform installed: {{ terraform_version_output.stdout_lines[0] }}"
  when:
    - install_terraform | default(true)
    - terraform_version_output is defined
  tags: terraform

# ============================================================================
# kubectl Installation
# ============================================================================

- name: Check if kubectl is installed
  command: kubectl version --client
  register: kubectl_installed
  ignore_errors: true
  changed_when: false
  when: install_kubectl | default(true)
  tags: kubectl

- name: Get installed kubectl version
  ansible.builtin.set_fact:
    installed_kubectl_version: "{{ kubectl_installed.stdout | regex_search('Client Version: v([0-9.]+)', '\\1') | first }}"
  when:
    - install_kubectl | default(true)
    - kubectl_installed is succeeded
  ignore_errors: true
  tags: kubectl

- name: Install/Update kubectl
  when:
    - install_kubectl | default(true)
    - kubectl_installed is failed or (installed_kubectl_version is defined and installed_kubectl_version != kubectl_version)
  tags: kubectl
  block:
    - name: Download kubectl
      get_url:
        url: "https://dl.k8s.io/release/v{{ kubectl_version }}/bin/linux/{{ system_arch }}/kubectl"
        dest: "{{ bin_directory }}/kubectl"
        mode: '0755'

    - name: Download kubectl checksum
      get_url:
        url: "https://dl.k8s.io/release/v{{ kubectl_version }}/bin/linux/{{ system_arch }}/kubectl.sha256"
        dest: "/tmp/kubectl.sha256"
        mode: '0644'

    - name: Verify kubectl checksum
      shell: |
        echo "$(cat /tmp/kubectl.sha256) {{ bin_directory }}/kubectl" | sha256sum --check
      register: kubectl_checksum
      changed_when: false

    - name: Clean up kubectl checksum file
      file:
        path: "/tmp/kubectl.sha256"
        state: absent

- name: Verify kubectl installation
  command: kubectl version --client
  register: kubectl_version_output
  changed_when: false
  when: install_kubectl | default(true)
  tags: kubectl

- name: Display kubectl version
  ansible.builtin.debug:
    msg: "kubectl installed: {{ kubectl_version_output.stdout_lines[0] }}"
  when:
    - install_kubectl | default(true)
    - kubectl_version_output is defined
  tags: kubectl

# ============================================================================
# talosctl Installation
# ============================================================================

- name: Check if talosctl is installed
  command: talosctl version --client
  register: talosctl_installed
  ignore_errors: true
  changed_when: false
  when: install_talosctl | default(true)
  tags: talosctl

- name: Get installed talosctl version
  ansible.builtin.set_fact:
    installed_talosctl_version: "{{ talosctl_installed.stdout | regex_search('Tag:\\s+v([0-9.]+)', '\\1') | first }}"
  when:
    - install_talosctl | default(true)
    - talosctl_installed is succeeded
  ignore_errors: true
  tags: talosctl

- name: Install/Update talosctl
  when:
    - install_talosctl | default(true)
    - talosctl_installed is failed or (installed_talosctl_version is defined and installed_talosctl_version != talosctl_version)
  tags: talosctl
  block:
    - name: Download talosctl checksums
      ansible.builtin.get_url:
        url: "https://github.com/siderolabs/talos/releases/download/v{{ talosctl_version }}/sha256sum.txt"
        dest: "/tmp/talosctl_{{ talosctl_version }}_sha256sum.txt"
        mode: '0644'
      register: talosctl_checksum_download
      retries: 3
      delay: 5
      until: talosctl_checksum_download is succeeded

    - name: Download talosctl binary
      ansible.builtin.get_url:
        url: "https://github.com/siderolabs/talos/releases/download/v{{ talosctl_version }}/talosctl-linux-{{ system_arch }}"
        dest: "/tmp/talosctl-linux-{{ system_arch }}"
        mode: '0755'
      register: talosctl_download
      retries: 3
      delay: 5
      until: talosctl_download is succeeded

    - name: Verify talosctl checksum
      ansible.builtin.shell: |
        cd /tmp
        grep "talosctl-linux-{{ system_arch }}" talosctl_{{ talosctl_version }}_sha256sum.txt | \
        sha256sum -c -
      changed_when: false

    - name: Install verified talosctl
      ansible.builtin.copy:
        src: "/tmp/talosctl-linux-{{ system_arch }}"
        dest: "{{ bin_directory }}/talosctl"
        mode: '0755'
        remote_src: true

    - name: Clean up talosctl download files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/talosctl-linux-{{ system_arch }}"
        - "/tmp/talosctl_{{ talosctl_version }}_sha256sum.txt"

- name: Verify talosctl installation
  command: talosctl version --client
  register: talosctl_version_output
  changed_when: false
  when: install_talosctl | default(true)
  tags: talosctl

- name: Display talosctl version
  ansible.builtin.debug:
    msg: "talosctl installed: {{ talosctl_version_output.stdout_lines | select('search', 'Tag:') | first }}"
  when:
    - install_talosctl | default(true)
    - talosctl_version_output is defined
  tags: talosctl

# ============================================================================
# Shell Completion
# ============================================================================

- name: Setup kubectl bash completion
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED KUBECTL COMPLETION"
    block: |
      # kubectl completion
      if command -v kubectl &> /dev/null; then
        source <(kubectl completion bash)
        complete -o default -F __start_kubectl k
        alias k=kubectl
      fi
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_kubectl | default(true)
  tags: kubectl

- name: Setup talosctl bash completion
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED TALOSCTL COMPLETION"
    block: |
      # talosctl completion
      if command -v talosctl &> /dev/null; then
        source <(talosctl completion bash)
      fi
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_talosctl | default(true)
  tags: talosctl

- name: Setup terraform bash completion
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED TERRAFORM COMPLETION"
    block: |
      # terraform completion
      if command -v terraform &> /dev/null; then
        complete -C $(which terraform) terraform
      fi
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_terraform | default(true)
  tags: terraform
