---
# Git configuration with backup and merge support
# Safely configures git without overwriting existing settings
#
# This task file:
# - Backs up existing git config
# - Reads existing configuration
# - Merges with new configuration
# - Applies non-conflicting settings

- name: Check if git is installed
  ansible.builtin.command: which git
  register: git_installed
  changed_when: false
  failed_when: false
  tags: git

- name: Git configuration block
  when: git_installed.rc == 0 and git_config is defined
  tags: git
  block:
    - name: Check if user git config exists
      ansible.builtin.stat:
        path: "/home/{{ target_user }}/.gitconfig"
      register: gitconfig_exists
      become: true
      become_user: "{{ target_user }}"

    - name: Backup existing git config
      ansible.builtin.copy:
        src: "/home/{{ target_user }}/.gitconfig"
        dest: "/home/{{ target_user }}/.gitconfig.backup.{{ ansible_date_time.epoch }}"
        remote_src: true
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0644'
      when: gitconfig_exists.stat.exists
      become: true
      become_user: "{{ target_user }}"

    - name: Read existing git configuration
      ansible.builtin.shell: |
        git config --global --list 2>/dev/null || echo ""
      register: existing_git_config
      become: true
      become_user: "{{ target_user }}"
      changed_when: false

    - name: Parse existing git config into dictionary
      ansible.builtin.set_fact:
        existing_git_dict: >-
          {%- set result = {} -%}
          {%- for line in existing_git_config.stdout_lines -%}
            {%- if '=' in line -%}
              {%- set key_value = line.split('=', 1) -%}
              {%- set _ = result.update({key_value[0]: key_value[1]}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ result }}

    - name: Flatten new git_config dictionary
      ansible.builtin.set_fact:
        git_config_flat: >-
          {%- set result = {} -%}
          {%- for section, settings in git_config.items() -%}
            {%- if settings is mapping -%}
              {%- for key, value in settings.items() -%}
                {%- set _ = result.update({section ~ '.' ~ key: value}) -%}
              {%- endfor -%}
            {%- else -%}
              {%- set _ = result.update({section: settings}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ result }}

    - name: Display configuration merge plan
      ansible.builtin.debug:
        msg:
          - "Git Configuration Merge Plan:"
          - "Existing settings: {{ existing_git_dict.keys() | list | length }}"
          - "New/Updated settings: {{ git_config_flat.keys() | list | length }}"
          - "Settings that will be updated:"
          - "{{ git_config_flat.keys() | list }}"

    - name: Apply git configuration (merge mode)
      community.general.git_config:
        name: "{{ item.key }}"
        value: "{{ item.value | string }}"
        scope: global
      loop: "{{ git_config_flat | dict2items }}"
      become: true
      become_user: "{{ target_user }}"
      when: git_config_flat | length > 0

    - name: Verify git configuration
      ansible.builtin.shell: |
        git config --global --list | grep -E "{{ item.key }}" || echo "not set"
      loop: "{{ git_config_flat | dict2items }}"
      register: git_verify
      become: true
      become_user: "{{ target_user }}"
      changed_when: false

    - name: Log git configuration changes
      ansible.builtin.lineinfile:
        path: "/var/log/ansible-security-audit.log"
        line: "{{ ansible_date_time.iso8601 }} | GIT_CONFIG | user={{ target_user }} | action=MERGE | settings_count={{ git_config_flat.keys() | list | length }} | ansible_user={{ ansible_user_id }}"
        create: true
        mode: '0600'
        owner: root
        group: root
      become: true

    - name: Display git configuration status
      ansible.builtin.debug:
        msg:
          - "Git configuration updated successfully!"
          - "Backup created: ~/.gitconfig.backup.{{ ansible_date_time.epoch }}"
          - "Settings applied: {{ git_config_flat.keys() | list | length }}"
          - ""
          - "View current config: git config --global --list"
          - "Compare with backup: diff ~/.gitconfig ~/.gitconfig.backup.{{ ansible_date_time.epoch }}"
