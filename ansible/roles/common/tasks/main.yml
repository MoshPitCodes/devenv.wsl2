---
# Common role - tasks
# Sets up common packages and configurations for all systems

- name: Ensure system is up to date
  ansible.builtin.apt:
    upgrade: dist
    update_cache: true
    cache_valid_time: 3600
  tags: update

- name: Install common system packages
  ansible.builtin.apt:
    name: "{{ common_packages }}"
    state: present
  tags: packages

- name: Install extra packages if defined
  ansible.builtin.apt:
    name: "{{ extra_packages }}"
    state: present
  when: extra_packages is defined and extra_packages | length > 0
  tags: packages

- name: Configure git settings with backup and merge
  ansible.builtin.include_tasks:
    file: git_config.yml
  when: git_config is defined and git_config | length > 0
  tags: git

- name: Create bash aliases
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BASH ALIASES"
    block: |
      # Custom aliases
      {% for alias_name, alias_command in bash_aliases.items() %}
      alias {{ alias_name }}='{{ alias_command }}'
      {% endfor %}
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: bash_aliases is defined
  tags: shell

- name: Add environment variables to .bashrc
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED ENVIRONMENT VARIABLES"
    block: |
      # Environment variables
      {% for var_name, var_value in environment_variables.items() %}
      export {{ var_name }}="{{ var_value }}"
      {% endfor %}
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: environment_variables is defined
  tags: shell

- name: Configure vm.swappiness
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "{{ vm_swappiness | default(10) }}"
    state: present
    sysctl_set: true
  when: vm_swappiness is defined
  tags: performance

- name: Setup unattended upgrades
  ansible.builtin.apt:
    name:
      - unattended-upgrades
      - apt-listchanges
    state: present
  when: enable_unattended_upgrades | default(false)
  tags: security

- name: Configure unattended upgrades
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    mode: '0644'
  when: enable_unattended_upgrades | default(false)
  tags: security

- name: Ensure user shell is set correctly
  ansible.builtin.user:
    name: "{{ target_user }}"
    shell: "{{ user_shell }}"
  tags: shell

- name: Configure WSL systemd if enabled
  ansible.builtin.include_tasks:
    file: wsl_systemd.yml
  when: wsl_enable_systemd | default(false)
  tags: wsl
